digraph {
  graph [nodesep=1, splines=line]
  node  [margin=0, shape=rect, width=1.3]
  edge  [color=darkblue]

  //
  // Nodes
  //
  Start               [label="POST /jobs/{job-id}", shape=oval, color=green]
  IsUserTokenProvided [label="Is User\nToken\nProvided?", shape=diamond]
  ValidateJobID       [label="Validate\njob id"]
  IsJobIDValid        [label="Is job id\n valid?", shape=diamond]
  401                 [label="401\nUnauthorized", shape=oval, color=red]
  404                 [label="404\nNot Found", shape=oval, color=red]
  204                 [label="204\nNo Content", shape=oval, color=green]
  JobLookup           [label="|Job lookup\nprocess|", shape=record]
  BlastWorkspaces     [label="MBlast\nworkspaces", shape=cylinder]
  IsExpired           [label="Is job\nexpired?", shape=diamond]
  CreateWorkspace     [label="Create job\nworkspace"]
  CreateQuery         [label="Create\nquery file"]
  ResubmitSubJobs     [label="|Resubmit\nsub jobs|", shape=record]



  //
  // Links
  //
  Start               -> IsUserTokenProvided
  401                 -> IsUserTokenProvided [headlabel="No", dir=back, color=darkred]
  IsUserTokenProvided -> ValidateJobID       [taillabel="Yes", color=darkgreen]
  ValidateJobID       -> IsJobIDValid        [constraint=false]
  404                 -> IsJobIDValid        [headlabel="No", color=darkred, dir=back]
  IsJobIDValid        -> JobLookup           [taillabel="Yes", color=darkgreen]
  JobLookup           -> 404                 [constraint=false, taillabel="Not found", color=darkred]
  JobLookup           -> IsExpired
  CreateWorkspace     -> IsExpired           [headlabel="Yes", dir=back, color=darkgreen]
  CreateWorkspace     -> CreateQuery
  BlastWorkspaces     -> CreateWorkspace     [constraint=false, style=dotted, dir=back]
  BlastWorkspaces     -> CreateQuery         [style=dotted, dir=back]
  CreateQuery         -> ResubmitSubJobs
  ResubmitSubJobs     -> 204 [constraint=false]
  IsExpired           -> 204 [taillabel="No", color=darkred]






  //
  // Formatting
  //
  {
    rank=same
    401
    IsUserTokenProvided
    ValidateJobID
  }
  {
    rank=same
    404
    IsJobIDValid
  }
  {
    rank=same
  }
  {
    rank=same
    CreateQuery
    BlastWorkspaces
  }
  {
    rank=same
    IsExpired
    CreateWorkspace
  }
  {
    rank=sink
    204
  }
  {
    edge [style=invis]
    IsUserTokenProvided -> IsJobIDValid
    BlastWorkspaces -> 204
    JobLookup -> CreateWorkspace
  }
}