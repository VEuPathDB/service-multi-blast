digraph {

  // Graph Settings
  graph[nodesep=1]
  node[margin=0, shape=rect, width=1.5]
  edge[color=darkblue]
  // splines=ortho
  compound=true

  //
  // Nodes
  //
  Start               [shape=oval, color=blue]
  CalcDigest          [label="Calculage\njob digest"]
  DigestInDB          [label="Digest\nalready\nin DB", shape=diamond]
  IsUserLinkedToJob   [label="User is\nlinked\nto job", shape=diamond]
  CreateWorkspace     [label="Create job\nworkspace"]
  CreateQueryFile     [label="Create\nquery file"]
  InsertJobInDB       [label="Insert job\ninto DB"]
  RefreshJobStatus    [label="Refresh job\nstatus"]
  JobStatusFailed     [label="Job\nstatus is\nfailed", shape=diamond]
  JobStillCached      [label="Job still\ncached", shape=diamond]
  UpdateJobLastUsed   [label="Update job\nlast used"]
  LinkUserToJob       [label="Link user\nto job"]
  SubmitJobToQueue    [label="Submit job\nto queue"]
  GetSubJobList       [label="Get sub\njob list"]
  HandleSubJobList    [label="| Process sub-jobs |", shape=record]
  200                 [label="200\nReturn job ID", shape=oval, color="green"]

  //
  // Links
  //
  Start             -> CalcDigest
  CalcDigest        -> DigestInDB
  DigestInDB        -> IsUserLinkedToJob [taillabel="Yes", color=darkgreen]
  DigestInDB        -> InsertJobInDB     [taillabel="No", color=darkred]
  InsertJobInDB     -> CreateWorkspace
  LinkUserToJob     -> RefreshJobStatus
  GetSubJobList     -> HandleSubJobList
  IsUserLinkedToJob -> RefreshJobStatus  [taillabel="Yes", color=darkgreen]
  IsUserLinkedToJob -> LinkUserToJob     [taillabel="No", color=darkred]
  RefreshJobStatus  -> JobStatusFailed
  JobStillCached    -> JobStatusFailed   [headlabel="No", color=darkred, dir=back]
  JobStillCached    -> UpdateJobLastUsed [taillabel="Yes", color=darkgreen]
  UpdateJobLastUsed -> GetSubJobList
  CreateWorkspace   -> CreateQueryFile
  CreateQueryFile   -> SubmitJobToQueue
  SubmitJobToQueue  -> GetSubJobList

  JobStatusFailed   -> 200 [taillabel="Yes", color=darkgreen]
  HandleSubJobList  -> 200

  //
  // Formatting
  //
  {
    rank=same
    IsUserLinkedToJob
    DigestInDB
    LinkUserToJob
  }
  {
    rank=same
    JobStillCached
    JobStatusFailed
  }
  {
    rank=same
    CreateQueryFile
    UpdateJobLastUsed
  }
  {
    rank=same
    SubmitJobToQueue
    GetSubJobList
  }
  {
    edge[style=invis]
    IsUserLinkedToJob -> JobStillCached
    CalcDigest -> LinkUserToJob
  }

  labelloc="t"
  label="Blast Job Submission"
}