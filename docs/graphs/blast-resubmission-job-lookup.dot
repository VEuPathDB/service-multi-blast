digraph {
  graph [nodesep=1, ranksep=0.7]
  node  [margin=0, shape=rect, width=1.5]
  edge  [color=darkblue]

  //
  // Nodes
  //

  Start               [label="Start", shape=oval]
  End                 [label="End", shape=oval]
  NotFound            [label="Not\nfound" shape=oval, color=darkred]

  LookupUserJob       [label="Lookup\nuser job"]
  LookupJob           [label="Lookup job"]
  DB                  [label="MBlast DB", shape=cylinder]
  DoesJobExist1       [label="Does user\njob exist?", shape=diamond]
  DoesJobExist2       [label="Does job\nexist?", shape=diamond]
  RefreshJobStatus    [label="Refresh job\nstatus"]
  LinkUserToJob       [label="Link user\nto job"]
  LinkUserToSubJobs   [label="|Link user\nto sub jobs|", shape=record]
  IsJobStillCached    [label="Is job\nexpired?", shape=diamond]
  UpdateLastUsed      [label="Update\nlast used"]

  //
  // Edges
  //

  Start              -> LookupUserJob

  LookupUserJob      -> DoesJobExist1
  LookupUserJob      -> DB                [dir=back, style=dotted, color="#333333"]

  DoesJobExist1      -> RefreshJobStatus  [taillabel="Yes", color=darkgreen]
  DoesJobExist1      -> LookupJob         [taillabel="No", color=darkred]

  LookupJob          -> DB                [dir=back, style=dotted, color="#333333", constraint=false]
  LookupJob:e        -> DoesJobExist2     []

  LinkUserToJob      -> DoesJobExist2     [headlabel="Yes", color=darkgreen, dir=back]
  DoesJobExist2      -> NotFound          [taillabel="No", color=darkred]

  LinkUserToJob      -> LinkUserToSubJobs
  LinkUserToJob      -> DB                [style=dotted, constraint=false, color="#333333"]

  LinkUserToSubJobs  -> RefreshJobStatus  []

  IsJobStillCached   -> RefreshJobStatus  [dir=back]

  IsJobStillCached:w -> UpdateLastUsed    [taillabel="No", color=darkred]
  IsJobStillCached   -> End               [taillabel="Yes", color=darkgreen]

  UpdateLastUsed     -> End

  //
  // Formatting
  //

  {
    rank=same
    LookupUserJob
    DoesJobExist1
    LookupJob
  }

  {
    rank=same
    RefreshJobStatus
    IsJobStillCached
    // UpdateLastUsed
  }

  {
    rank=sink
    NotFound
    End
  }

  {
    rank=same
    DoesJobExist2
    LinkUserToJob
  }

  {
    edge [style=invis]
    LookupJob -> LinkUserToJob
    LinkUserToSubJobs -> IsJobStillCached
    DoesJobExist1 -> LinkUserToJob
    // UpdateLastUsed -> NotFound
    Start -> LookupJob
  }

}