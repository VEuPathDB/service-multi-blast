digraph {
  splines=ortho
  nodesep=0.5
  node[shape=rect, margin=0, width=1]
  edge[color=darkblue]

  // Nodes
  Start           [shape=oval, color=blue]
  Remaining       [label="More\nsub-jobs\nremain", shape=diamond]
  CreateWorkspace [label="Create job\nworkspace"]
  CreateQueryFile [label="Create\nquery file"]
  SubmitToQueue   [label="Submit job\nto queue"]
  UpdateLastUsed  [label="Update job\nlast used"]
  StillCached     [label="Job still\ncached", shape=diamond]
  RefreshStatus   [label="Refresh job\nstatus"]
  StatusFailed    [label="Job\nstatus is\nfailed", shape=diamond]
  LinkUser        [label="Link user\nto job"]
  IsUserLinked    [label="Is user\nlinked\nto job", shape=diamond]
  End             [shape=oval, color=green]

  // Links
  Start           -> Remaining
  Remaining       -> IsUserLinked    [taillabel=" Yes", color=darkgreen]
  IsUserLinked    -> LinkUser        [taillabel="\n  No", color=darkred]
  IsUserLinked    -> RefreshStatus   [taillabel="Yes  ", color=darkgreen]
  LinkUser        -> RefreshStatus
  RefreshStatus   -> StatusFailed
  StatusFailed    -> Remaining       [taillabel="Yes", color=darkgreen, constraint=false]
  StatusFailed    -> StillCached     [taillabel="\nNo", color=darkred]
  UpdateLastUsed  -> StillCached     [headlabel="Yes", color=darkgreen, dir=back]
  StillCached     -> CreateWorkspace [taillabel="No", color=darkred]
  CreateWorkspace -> CreateQueryFile
  SubmitToQueue   -> CreateQueryFile [dir=back, constraint=false]
  SubmitToQueue   -> Remaining
  UpdateLastUsed  -> Remaining
  End             -> Remaining       [headlabel="No", color=darkred, dir=back]

  // Layout
  {
    rank=same;
    StillCached
    UpdateLastUsed
  }
  {
    rank=same
    CreateQueryFile
    SubmitToQueue
  }
  {
    rank=same
    Remaining
    End
    IsUserLinked
  }

  label="For each sub-job"
  labelloc="t"
}