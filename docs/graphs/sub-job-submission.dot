digraph {
  // splines=ortho
  graph [nodesep=0.7]
  node  [shape=rect, margin=0, width="1.2"]
  edge  [color=darkblue]

  // Nodes
  Start           [shape=oval, color=blue]
  Remaining       [label="More\nsub-jobs\nremain", shape=diamond]
  NextJob         [label="Next\nsub-job"]
  HashJob         [label="Calculate\njob digest"]
  LookupUserJob   [label="Lookup\nuser job"]
  FoundUserJob    [label="Found\nuser job?", shape=diamond]
  LookupJob       [label="Lookup job"]
  FoundJob        [label="Found\njob?", shape=diamond]
  InsertJobIntoDB [label="Insert job\ninto DB"]
  CreateWorkspace [label="Create job\nworkspace"]
  CreateQueryFile [label="Create\nquery file"]
  SubmitToQueue   [label="Submit job\nto queue"]
  UpdateLastUsed  [label="Update job\nlast used"]
  RefreshStatus   [label="Refresh job\nstatus"]
  StatusSwitch    [label="Switch:\njob status", shape=diamond]
  LinkUser1       [label="Link user\nto job"]
  End             [shape=oval, color=green]

  //
  // Edges
  //

  Start           -> Remaining

  Remaining       -> NextJob         [taillabel="Yes", color=darkgreen]
  End             -> Remaining       [headlabel="No", color=darkred, dir=back]

  NextJob         -> HashJob

  HashJob         -> LookupUserJob

  LookupUserJob   -> FoundUserJob

  FoundUserJob    -> RefreshStatus [taillabel="Yes", color=darkgreen]
  FoundUserJob    -> LookupJob     [taillabel="No", color=darkred]

  LookupJob       -> FoundJob

  FoundJob        -> LinkUser1       [taillabel="Yes", color=darkgreen]
  FoundJob        -> InsertJobIntoDB [taillabel="No", color=darkred]

  InsertJobIntoDB -> CreateWorkspace

  LinkUser1 -> RefreshStatus
  RefreshStatus   -> StatusSwitch

  StatusSwitch    -> Remaining       [taillabel="Errored /\nIn Progress"]
  UpdateLastUsed  -> StatusSwitch    [taillabel="Complete", dir=back]
  StatusSwitch    -> CreateWorkspace [taillabel="Expired", constraint=false]

  CreateWorkspace -> CreateQueryFile
  SubmitToQueue   -> CreateQueryFile [dir=back, constraint=false]
  SubmitToQueue   -> Remaining
  UpdateLastUsed  -> Remaining

  //
  // Layout
  //
  {
    rank=same
    End
    Remaining
    NextJob
  }

  {
    rank=same
    StatusSwitch
    CreateWorkspace
    UpdateLastUsed
  }
  {
    rank=same
    CreateQueryFile
    SubmitToQueue
  }
  {
    rank=same
    FoundUserJob
    LookupJob
  }
  {
    rank=same
    FoundJob
    // RefreshStatus
    // LinkUser1
  }
  {
    edge [style=invis]
    FoundUserJob -> LinkUser1
  }

  label="For Each Sub-Job"
  labelloc="t"
}