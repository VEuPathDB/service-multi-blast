digraph {
  graph [nodesep=1, ranksep=0.8]
  node  [margin=0, shape=rect, width=1.5]
  edge  [color=darkblue]

  //
  // Nodes
  //

  // Response Codes
  401 [shape=oval, color=orange]
  404 [shape=oval, color=orange]
  200 [label="200\nJob details", shape=oval, color=darkgreen]

  // External Resources
  DB    [label="MBlast DB", shape=cylinder, color=purple]
  FS    [label="MBlast\nworkspaces", shape=cylinder, color=purple]
  Queue [label="Job queue", shape=component, color=purple]

  Start               [label="GET /jobs/{job-id}", shape=oval, color=darkgreen]
  IsUserTokenProvided [label="Is user\ntoken\nprovided?", shape=diamond]
  ValidateJobID       [label="|Job ID hash\nvalidation|", shape=record]
  LookupUserJob       [label="|Lookup\nuser job|", shape=record]
  LookupJob           [label="Lookup job"]
  DoesJobExist1       [label="Does user\njob exist?", shape=diamond]
  DoesJobExist2       [label="Does job\nexist?", shape=diamond]
  RefreshJobStatus    [label="|Refresh\njob status|", shape=record]
  LinkUserToJob       [label="Link user\nto job"]
  LinkUserToSubJobs   [label="|Link user\nto sub jobs|", shape=record]
  IsJobStillCached    [label="Is job\nstatus\nexpired?", shape=diamond]
  UpdateLastUsed      [label="Update\nlast used"]

  //
  // Edges
  //

  Start               -> IsUserTokenProvided

  IsUserTokenProvided -> ValidateJobID       [taillabel="Yes", color=darkgreen]
  401                 -> IsUserTokenProvided [headlabel="No", color=darkred, dir=back]

  ValidateJobID       -> LookupUserJob
  ValidateJobID       -> 404                 [taillabel="Invalid\nhash", color=darkred, constraint=false]

  LookupUserJob       -> DoesJobExist1
  LookupUserJob       -> DB                  [dir=back, style=dotted, color="#333333"]

  DoesJobExist1       -> RefreshJobStatus    [taillabel="Yes", color=darkgreen]
  DoesJobExist1       -> LookupJob           [taillabel="No", color=darkred]

  LookupJob           -> DoesJobExist2       []
  LookupJob           -> DB                  [dir=back, style=dotted, color="#333333"]

  DoesJobExist2       -> LinkUserToJob       [taillabel="Yes", color=darkgreen]
  404                 -> DoesJobExist2:w     [headlabel="No", color=darkred, dir=back, constraint=false]

  LinkUserToJob       -> LinkUserToSubJobs
  LinkUserToJob       -> DB                  [style=dotted, color="#333333"]

  LinkUserToSubJobs   -> RefreshJobStatus

  RefreshJobStatus    -> IsJobStillCached
  RefreshJobStatus    -> Queue               [style=dotted, color="#333333"]
  RefreshJobStatus    -> FS                  [dir=back, style=dotted, color="#333333"]

  IsJobStillCached:e  -> UpdateLastUsed      [taillabel="No", color=darkred]
  IsJobStillCached:s  -> 200                 [taillabel="Yes", color=darkgreen]
  UpdateLastUsed      -> 200

  //
  // Formatting
  //
  {
    rank=same
    IsUserTokenProvided
    401
  }
  {
    rank=same
    FS
    LinkUserToSubJobs
  }
  {
    rank=same
    404
    LookupUserJob
  }
  {
    rank=same
    DoesJobExist2
    DB
  }

  {
    edge [style=invis]
    DB -> FS -> Queue -> 200
    401 -> 404
    RefreshJobStatus -> UpdateLastUsed
  }
}