= Multi-Blast 2.0 Design
:source-highlighter: highlightjs
:toc: preamble
:var-github-url: https://github.com
:var-git-org-url: {var-github-url}/VEuPathDB

image:assets/mblast-overview.png[]

== The Stack

The Multi-Blast 2.0 service stack consists of 4 containers and 3 external
dependencies.

.Containers
1. The <<Query Service>>
2. The <<Report Service>>
3. A RabbitMQ message queue
4. A PostgreSQL database

.Dependencies
1. The VEuPathDB Oracle user database.
2. The VEuPathDB link:https://blast.ncbi.nlm.nih.gov/Blast.cgi[BLAST+]
   databases.
3. An S3 instance with a bucket created for each of the Query Service and Report
Service.

== Query Service

The Query Service, built on the
link:{var-git-org-url}lib-compute-platform[Async Platform], exposes a REST API
through which API consumers may create, customize, and execute asynchronous
link:https://blast.ncbi.nlm.nih.gov/Blast.cgi[BLAST+] query jobs against
VEuPathDB's BLAST+ databases.

link:https://veupathdb.github.io/service-multi-blast/service-query/api.html[REST API Documentation]

The results of jobs executed through the query service will be cached for a
configurable amount of time before they are automatically expired.

.Query Service Overview
image:assets/mblast-query-overview.png[]


=== Actions

[%header, cols="2,1,7"]
|===
| Action | Source | Description

| <<#list-query-jobs,List Jobs>>
| Client
| Lists the <<Primary Jobs>> that are <<linked>> to the requesting user.

| <<#create-query-job,Create Job>>
| Client
| Creates a new query job and may optionally <<link>> the new job to the
  requesting user.

| <<#lookup-query-job,Lookup Job>>
| Client
| Get the details and configuration for an existing job and optionally link the
  requesting user to the target job.

| <<restart-query-job,Restart Job>>
| Client
| Re-runs an existing job that has expired.

| <<update-query-job,Update Job>>
| Client
| Update a user's metadata attached to a job.

| <<delete-query-job,Delete Job>>
| Client
| Unlink a job from the requesting user.

| <<get-job-query,Get Job Query>>
| Client
| Retrieve the raw query submitted for a target job.

| <<get-job-result,Get Job Result>>
| Client
| Retrieve the ASN1 query result of the target job.

| <<get-job-errors,Get Job Errors>>
| Client
| Retrieve the stderr output for a target job.

| <<bulk-query-status,Bulk Status Check>>
| Client
| Check the current statuses for a batch of job IDs.

| <<Get All Targets>>
| Client
| List the BLAST+ databases currently visible to the service.

| <<link-query-guest,Link Guest>>
| Client
| Links the jobs associated with a guest user with a target non-guest user.

| <<Execute Query>>
| Queue
| Asynchronously executes a BLAST+ query.
|===

[#list-query-jobs]
==== List Jobs

Look up the jobs that are linked to the requesting user.  Optionally, the
results may be filtered by project ID.

===== Workflow

. Look up jobs attached to the requesting user in the user database
. Optionally filter results by project id
. Look up statuses of jobs from the Async Platform
. Return the list of items which will include:
* job id
* job status
* project id
* user metadata

[#create-query-job]
==== Create Job

Creates a new job record if one does not already exist matching the POSTed
configuration.  See <<Job IDs>>.

===== Workflow

. Validate the job configuration
. Validate the input query
. Hash the config and query to generate a job ID
. Verify no matching job already exists in the database
. Record the job in the user database
. Optionally link the requesting user to the job in the user database
. Submit the job to the Async Platform
. Return the generated job ID

[#lookup-query-job]
==== Lookup Job

Retrieves a detailed record for a specific target job which will include the
original configuration from which the job was created.

Additionally, as a simplistic form of job "sharing", users who make a request to
get a job's details may optionally be linked to the target job, adding it to the
requesting user's job collection.

To maintain compatibility with the legacy behavior of the `v0.x` and `v1.x`
Multi-Blast API, the job saving behavior is opt-out only and by default users
will be linked to jobs they request that they are not already linked to.

===== Workflow

. Look up job in user database
. Optionally link requesting user to the job in the user database
. Check the status of the job
. Return the job details which will include:
* job id
* job status
* job configuration:
** target BLAST+ databases
** target project id
* blast configuration
* user metadata

[#restart-query-job]
==== Restart Job

Restarts an expired job.  Once a job has expired from the cache, users are
allowed to re-run the job without needing to resubmit the configuration.

The configuration for the job is stored and will be resubmitted to the job queue
the same as if the job was brand new.

===== Workflow

. Look up job in user database
. Verify user is linked to job
. Verify job is in the status "expired"
. Resubmit the job to the Async Platform

[#update-query-job]
==== Update Job

Updates the metadata a user has associated with a target job to which they are
already linked.

===== Workflow

. Look up the target job in the user database
. Verify user is linked to the target job
. Update the user's metadata for the job in the user database

[#delete-query-job]
==== Delete Job

Removes a target job from the user's job collection, deleting the link between
the user and the target job.

===== Workflow

. Look up the target job in the user database
. Verify the requesting user is linked to the target job
. Delete the link between the requesting user and the target job

[#get-job-query]
==== Get Job Query

Retrieves the query submitted for a job.

===== Workflow

. Look up the target job in the user database
. Return the job's query

[#get-job-result]
==== Get Job Result

Retrieves the ASN1 query result generated by a query job that has completed
successful.

===== Workflow

. Look up the target job in the user database
. Look up the target job in S3
. Verify the job's status is "complete"
. Return the job's result file

[#get-job-errors]
==== Get Job Errors

Retrieves the stderr output from the BLAST+ command-line tool that was executed
as part of a job.

===== Workflow

. Look up the target job in the user database
. Look up the target job in S3
. Verify the job's is in either the "complete" or "failed" status
. Return the job's stderr file

[#bulk-query-status]
==== Bulk Status Check

. For each ID POSTed
.. Look up the job in S3
.. Get the job's status
. Return the found statuses

==== Get All Targets

Returns a tree of all the queryable BLAST+ databases that are available to use.

===== Workflow

1. Traverse the BLAST+ store directory structure to build a list of available
   BLAST+ target databases
2. Return the assembled list

[#link-query-guest]
==== Link Guest

RPC-like API endpoint used to migrate ownership of jobs created by a WDK guest
user to a logged-in user.  The use case being situations where a user creates
jobs before either realizing they weren't logged in, or deciding to create an
account.

===== Workflow

. Verify the target user from which jobs will be migrated is actually a WDK
  guest user.
. Verify the requesting user to which jobs will be migrated is actually a
  logged-in WDK user.
. Transfer user link ownership from the guest user to the logged-in user for all
  jobs linked to the guest.

==== Execute Query

Internal, asynchronous execution of a target BLAST+ command-line tool using a
user provided configuration.

This execution happens in worker threads that pull jobs from the RabbitMQ
message queue backing the Async Platform.

===== Workflow

. Translate the query config to a CLI call
. Execute the BLAST+ CLI tool
. Record the stderr output to file
. Post the exit code back to the response channel of the message queue

=== Dependencies

* S3
* RabbitMQ
* PostgreSQL
* Oracle
* BLAST+ Databases


== Report Service

The Report Service, built on the
link:{var-git-org-url}lib-compute-platform[Async Platform], exposes a REST API
through which API consumers may generate custom reports from BLAST+ queries
executed using the <<Query Service>>.

link:https://veupathdb.github.io/service-multi-blast/service-report/api.html[REST API Documentation]

.Report Service Overview
image:assets/mblast-report-overview.png[]


=== Actions

[%header, cols="2,1,7"]
|===
| Action | Source | Description

| <<list-report-jobs,List Jobs>>
| Client
| Lists the jobs that are linked to the requesting user.

| <<create-report-job,Create Job>>
| Client
| Creates a new report job and may optionally link the new job to the requesting
  user.

| <<create-report-job,Lookup Job>>
| Client
| Get the details and configuration for an existing job.

| <<restart-report-job,Restart Job>>
| Client
| Re-runs an existing job that has expired.

| <<update-report-job,Update Job>>
| Client
| Update a user's metadata attached to a job.

| <<delete-report-job,Delete Job>>
| Client
| Unlink a job from the requesting user.

| <<list-report-job-files,List Job Outputs>>
| Client
| List the report files generated by a target job.

| <<get-report-job-file,Get Job Output>>
| Client
| Retrieve a report file generated by a target job.

| <<get-report-job-error,Get Job Errors>>
| Client
| Retrieve the stderr output for a target job.

| <<bulk-report-check,Bulk Status Check>>
| Client
| Check the current statuses for a batch of job IDs.

| <<link-report-guest,Link Guest>>
| Client
| Links the jobs associated with a guest user with a target non-guest user.

| <<execute-report,Execute Report>>
| Queue
| Executes the BLAST+ CLI tool `blast_formatter` using a target query job's
  result as the input.
|===

[#list-report-jobs]
==== List Jobs

Looks up the jobs that are linked to the requesting user.  Optionally the
results may be filtered by query job ID.

[#create-report-job]
==== Create Job

Creates a new job if one does not already exist matching the POSTed
configuration.

If the job did not previously exist, or was previously expired, it will be
queued to be executed.

[#lookup-report-job]
==== Lookup Job

Retrieves a detailed record for a specific target job which will include the
original configuration from which the job was created.

Additionally, as a simplistic form of job "sharing", users who make a request to
get a job's details may optionally be linked to the target job, adding it to the
requesting user's job collection.

To maintain compatibility with the legacy behavior of the `v0.x` and `v1.x`
Multi-Blast API, the job saving behavior is opt-out only and by default, users
will be linked to jobs they request that they are not already linked to.

[#restart-report-job]
==== Restart Job

Restarts an expired job.  Once a job has expired from the cache, users are
allowed to re-run the job without needing to resubmit the configuration.

The configuration for the job is stored and will be resubmitted to the job queue
the same as if the job was brand new.

[#update-report-job]
==== Update Job

Updates the metadata a user has associated with a target job to which they are
already linked.

[#delete-report-job]
==== Delete Job

Removes a target job from the user’s job collection, deleting the link between
the user and the target job.

[#list-report-job-files]
==== List Job Outputs

Lists the files generated by a completed report job.

[#get-report-job-file]
==== Get Job Output

Retrieves the target file generated by a completed report job.

[#get-report-job-error]
==== Get Job Errors

Retrieves the stderr output from the BLAST+ command-line tool that was executed
as part of a job.

[#bulk-report-check]
==== Bulk Status Check

Looks up a bulk batch of job statuses.

[#link-report-guest]
==== Link Guest

Migrates the ownership of links between a target guest user and a target job to
be owned by a logged-in user.  The use case being situations where a WDK user
creates jobs before either realizing they weren't logged in, or deciding to
create an account.

[#execute-report]
==== Execute Report

Internal, asynchronous execution of the BLAST+ formatter command-line tool using
a user provided configuration.

This execution happens in worker threads that pull jobs from the RabbitMQ
message queue backing the Async Platform.

=== Dependencies

. Query Service
. S3
. RabbitMQ
. PostgreSQL
. Oracle
. BLAST+ Databases

== Concepts

.TODO
* User metadata
* Parent / child jobs
* Primary / secondary jobs
* Job Links

=== Job IDs

A job ID is a hash of the job's configuration and query.  This means that if the
same configuration is submitted multiple times, the resulting job ID will be the
same every time.

==== For the Query Service

For the <<Query Service>>, the generated job IDs are dependent on:

* the BLAST+ query tool configuration
* the target project ID
* the input query text
* the selected query targets
** the name of the target
** the name of the database file

==== For the Report Service

For the <<Report Service>>, the generated job IDs are dependent on:

* the ID of the query service job for which the report will be generated
* the BLAST+ formatter tool configuration

