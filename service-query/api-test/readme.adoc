= MBlast Query Service API End-to-End Tests
:source-highlighter: highlightjs

== Usage

=== Prerequisites

* Docker
* Java 17+
* A built mblast docker-compose stack
* A sshuttle tunnel

=== Execution

1. From the root of the repository, first spin up the MBlast Docker Compose
stack:
+
[source, bash]
----
./gradlew compose-up
----
+
.Example Output
[%collapsible]
====
[source, console]
----
> Task :compose-up
Network mblast_internal  Creating
Network mblast_internal  Created
Container mblast-minio-1  Creating
Container mblast-queue-db-1  Creating
Container mblast-queue-1  Creating
Container mblast-minio-1  Created
Container mblast-minio-create-buckets-1  Creating
Container mblast-queue-1  Created
Container mblast-queue-db-1  Created
Container mblast-query-service-1  Creating
Container mblast-minio-create-buckets-1  Created
Container mblast-query-service-1  Created
Container mblast-minio-1  Starting
Container mblast-queue-db-1  Starting
Container mblast-queue-1  Starting
Container mblast-minio-1  Started
Container mblast-minio-create-buckets-1  Starting
Container mblast-queue-1  Started
Container mblast-queue-db-1  Started
Container mblast-query-service-1  Starting
Container mblast-minio-create-buckets-1  Started
Container mblast-query-service-1  Started

BUILD SUCCESSFUL in 3s
----
====

2. Verify the mblast service starts up and comes online normally by watching the
service log until the server is listening for requests:
+
[source, bash]
----
docker logs --follow mblast-query-service-1
----
+
.Example Output
[%collapsible]
====
[source, console]
----
Awaiting service dependencies.
Testing connectivity to job queue 1
Waiting for queue to become available
queue [192.168.224.4] 5672 (amqp) : Connection refused
queue is not yet available, will test again in 2 seconds
queue [192.168.224.4] 5672 (amqp) open
queue is available
Testing connectivity to PostgreSQL
Waiting for queue-db to become available
queue-db [192.168.224.3] 5432 (postgresql) open
queue-db is available
Testing connectivity to Minio
Waiting for minio to become available
minio [192.168.224.2] 9000 (?) open
minio is available
WARNING: sun.reflect.Reflection.getCallerClass is not supported. This will impact performance.
2022-10-19 11:59:13.822 [rid:init0][jid:] DEBUG Log:29 - Logger initialized
2022-10-19 11:59:13.822 [rid:init0][jid:] INFO  Server:168 - Starting server
2022-10-19 11:59:13.864 [rid:init0][jid:] INFO  AsyncPlatform:54 - Initializing async platform
2022-10-19 11:59:13.864 [rid:init0][jid:] DEBUG JobQueues:31 - initializing job queue manager
2022-10-19 11:59:13.865 [rid:init0][jid:] INFO  QueueWrapper:39 - initializing queue wrapper for queue primary-queries

... cont'd log lines ...

Oct 19, 2022 11:59:15 AM org.glassfish.jersey.server.wadl.WadlFeature configure
WARNING: JAXBContext implementation could not be found. WADL feature is disabled.
Oct 19, 2022 11:59:15 AM org.glassfish.grizzly.http.server.NetworkListener start
INFO: Started listener bound to [0.0.0.0:8080]
Oct 19, 2022 11:59:15 AM org.glassfish.grizzly.http.server.HttpServer start
INFO: [HttpServer] Started.
2022-10-19 11:59:15.378 [rid:init0][jid:] INFO  Server:220 - Server started.  Listening on port 8080.
----
====

3. Once the service is listening for connections run the API tests:
+
[source, bash]
----
./gradlew :service-query:query-api-test:test --rerun-tasks
----
+
.Example Output
[%collapsible]
====
[source, console]
----
> Task :service-query:query-api-test:test

POST /query/jobs > responds with a 400 when > the request body is empty STANDARD_OUT
    HTTP/1.1 400 Bad Request
    Set-Cookie: JSESSIONID=6679260102301004548; Path=/
    Content-Type: application/json
    Connection: close
    Content-Length: 75

    {
        "status": "bad-request",
        "message": "Request contained no job configuration"
    }

POST /query/jobs > responds with a 400 when > the request body is empty PASSED

POST /query/jobs > responds with a 400 when > the request config is not a json object STANDARD_OUT
    HTTP/1.1 400 Bad Request
    Set-Cookie: JSESSIONID=6386477003692596744; Path=/
    Content-Type: application/json
    Connection: close
    Content-Length: 78

... cont'd test output ...

        }
    }

POST /query/jobs > responds with a 422 when > the job config is an empty json object PASSED

BUILD SUCCESSFUL in 7s
8 actionable tasks: 8 executed
----
====