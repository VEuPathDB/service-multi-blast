#!/usr/bin/env sh

files=$(find docs/schema -name '*.json' -o -name '*.yml' -o -name '*.yaml')

mkdir -p docs/raml

echo "#%RAML 1.0 Library

################################################################################
#                                                                              #
#  DO NOT EDIT THIS FILE; IT WAS GENERATED AUTOMATICALLY.                      #
#  CHANGES MADE HERE WILL BE LOST.                                             #
#                                                                              #
################################################################################

types:" > docs/raml/library.raml

getId() {
  tr '\n\r' ' ' < "$1" \
    | grep -Eo '"?\$id"?\s*:\s*"?([A-Za-z0-9_]+)"?' \
    | sed 's/ \|"//g' \
    | cut -d':' -f2
}

for file in ${files}; do
  name=$(getId "${file}")

  if [ -z "${name}" ]; then
    continue
  fi

  json-dereference -s "${file}" -o "tmp_.json" > /dev/null
  js2dt "tmp_.json" "${name}" \
    | grep -v '#%\|types:' >> docs/raml/library.raml
  rm "tmp_.json"
done
